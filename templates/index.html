{% extends "layout.html" %}

{% block content %}
<style>
    /* สไตล์เดิม */
    .alert-box { padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }
    .alert-error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    .alert-conflict { color: #856404; background-color: #fff3cd; border-color: #ffeeba; }

    .action-bar { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .btn-add { background-color: #5bc0de; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px; border: none; cursor: pointer; }
    .btn-add:hover { background-color: #31b0d5; }
    .btn-about { background-color: #6c757d; color: white; padding: 10px 15px; text-decoration: none; border-radius: 5px; }
    .btn-about:hover { background-color: #5a6268; }
    .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .user-controls a { margin-left: 10px; text-decoration: none; }

    /* --- [เพิ่มใหม่] สไตล์สำหรับปุ่มกดดูประวัติ --- */
    .toggle-history-btn {
        margin-left: 20px; 
        padding: 5px 10px; 
        color: #888; 
        font-size: 0.9em; 
        font-style: italic; 
        cursor: pointer;
        user-select: none; /* ห้ามลากคลุมดำ */
        transition: color 0.3s;
    }
    .toggle-history-btn:hover {
        color: #5bc0de;
        text-decoration: underline;
    }
</style>

<div class="container">
    
    <div class="user-header">
        <h1>Blog Posts</h1>
        <div class="user-controls">
            {% if current_user.is_authenticated %}
                <span>สวัสดี, <strong>{{ current_user.username }}</strong></span>
                <a href="{{ url_for('logout') }}" style="color: #e74c3c;">Logout</a>
            {% else %}
                <a href="{{ url_for('login') }}" style="color: #5bc0de;">Login</a>
                <a href="{{ url_for('register') }}" style="color: #5bc0de;">Register</a>
            {% endif %}
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert-box alert-{{ category }}">
            <strong>แจ้งเตือน:</strong> {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="action-bar">
        {% if current_user.is_authenticated %}
            <a class="btn-add" href="{{ url_for('create') }}">Add New Post</a>
        {% endif %}
        <a class="btn-about" href="https://asia-southeast1-sda-project-48621.cloudfunctions.net/hello_web" target="_blank">About Us</a>
    </div>

    {% for post in posts %}
    <div class="post">
        <h2>{{ post.title }}</h2>
        
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 5px;">
            <p>{{ post.content }}</p>
        </div>

        {% if post.updates %}
            
            {% if post.updates|length > 1 %}
                <div id="btn-{{ post.id }}" 
                     class="toggle-history-btn"
                     onclick="toggleHistory('{{ post.id }}')"
                     data-text="... {{ post.updates|length - 1 }} previous updates hidden (Click to show) ...">
                    ... {{ post.updates|length - 1 }} previous updates hidden (Click to show) ...
                </div>

                <div id="history-{{ post.id }}" style="display: none;">
                    {% for update in post.updates[:-1] %}
                        <div style="margin-top: 10px; margin-left: 20px; padding: 10px; border-left: 4px solid #6c757d; background: rgba(0,0,0,0.1);">
                            <p style="margin: 0; color: #ccc;">{{ update.content }}</p>
                            <small style="color: #888;">
                                History: <strong>{{ update.user.username }}</strong> 
                                at {{ update.updated_at.strftime('%H:%M:%S') }}
                            </small>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% set last_update = post.updates[-1] %}
            <div style="margin-top: 10px; margin-left: 20px; padding: 10px; border-left: 4px solid #5bc0de; background: rgba(0,0,0,0.2);">
                <p style="margin: 0;">{{ last_update.content }}</p>
                <small style="color: #aaa;">
                    Latest Update: <strong>{{ last_update.user.username }}</strong> 
                    at {{ last_update.updated_at.strftime('%H:%M:%S') }}
                </small>
            </div>

        {% endif %}

        <div class="meta">
            Created at: {{ post.created_at.strftime('%d %b %Y, %I:%M %p') }} <br>
            <span style="color: #ffc107;">Original Author: <strong>{{ post.author.username }}</strong></span>
        </div>

        {% if current_user.is_authenticated %}
            <div style="margin-top: 10px;">
                <a class="btn edit-btn" href="/edit/{{ post.id }}">Add Update</a>
                {% if post.author == current_user %}
                    <a class="btn delete-btn" href="/delete/{{ post.id }}" onclick="return confirm('Are you sure you want to delete this item?');">Delete</a>
                {% endif %}
            </div>
        {% endif %}
    </div>
    <hr> 
    {% endfor %}

</div>

<script>
function toggleHistory(postId) {
    var historyDiv = document.getElementById("history-" + postId);
    var btn = document.getElementById("btn-" + postId);
    
    // ถ้าปิดอยู่ -> ให้เปิด
    if (historyDiv.style.display === "none") {
        historyDiv.style.display = "block";
        btn.innerHTML = "▼ Hide previous updates"; // เปลี่ยนข้อความปุ่ม
        btn.style.color = "#5bc0de"; // เปลี่ยนสีปุ่มให้รู้ว่าเปิดอยู่
    } 
    // ถ้าเปิดอยู่ -> ให้ปิด
    else {
        historyDiv.style.display = "none";
        btn.innerHTML = btn.getAttribute("data-text"); // เอาข้อความเดิมกลับมา
        btn.style.color = "#888"; // กลับเป็นสีเทา
    }
}
</script>
{% endblock %}