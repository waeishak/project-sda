{% extends "layout.html" %}

{% block content %}
<style>
    /* สไตล์เดิมที่จำเป็น */
    .alert-box { padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }
    .alert-error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    .alert-conflict { color: #856404; background-color: #fff3cd; border-color: #ffeeba; }

    /* ปรับ Action bar ให้ปุ่ม Add Post ไปอยู่ขวาสุด */
    .action-bar { 
        margin-bottom: 25px; 
        display: flex; 
        align-items: center; 
        justify-content: flex-end; /* ดันปุ่มไปขวาสุด */
    }

    .toggle-history-btn { margin-left: 20px; padding: 5px 10px; color: #888; font-size: 0.9em; font-style: italic; cursor: pointer; user-select: none; transition: color 0.3s; }
    .toggle-history-btn:hover { color: #5bc0de; text-decoration: underline; }
</style>

<div class="hero-banner">
    <div class="hero-content">
        <h1>Welcome to Comeng Blog</h1>
        <p>Sharing knowledge, code, and innovations.</p>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert-box alert-{{ category }}">
        <strong>แจ้งเตือน:</strong> {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="action-bar">
    {% if current_user.is_authenticated %}
        <a class="btn add-btn" href="{{ url_for('create') }}">+ Add New Post</a>
    {% endif %}
</div>

{% for post in posts %}
<div class="post">
    <h2>{{ post.title }}</h2>
    
    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px;">
        <p style="white-space: pre-wrap;">{{ post.content }}</p>
    </div>

    {% if post.updates %}
        {% if post.updates|length > 1 %}
            <div id="btn-{{ post.id }}" 
                 class="toggle-history-btn"
                 onclick="toggleHistory('{{ post.id }}')"
                 data-text="... {{ post.updates|length - 1 }} previous updates hidden (Click to show) ...">
                ... {{ post.updates|length - 1 }} previous updates hidden (Click to show) ...
            </div>

            <div id="history-{{ post.id }}" style="display: none;">
                {% for update in post.updates[:-1] %}
                    <div style="margin-top: 15px; margin-left: 20px; padding: 15px; border-left: 4px solid #6c757d; background: rgba(0,0,0,0.2); border-radius: 0 8px 8px 0;">
                        <p style="margin: 0; color: #ccc;">{{ update.content }}</p>
                        <small style="color: #888; display: block; margin-top: 5px;">
                            History: <strong>{{ update.user.username }}</strong> 
                            at {{ update.updated_at.strftime('%H:%M:%S') }}
                        </small>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% set last_update = post.updates[-1] %}
        <div style="margin-top: 15px; margin-left: 20px; padding: 15px; border-left: 4px solid #5bc0de; background: rgba(0,0,0,0.3); border-radius: 0 8px 8px 0;">
            <p style="margin: 0; font-size: 1.1em;">{{ last_update.content }}</p>
            <small style="color: #aaa; display: block; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                Latest Update: <strong style="color: #61dafb;">{{ last_update.user.username }}</strong> 
                at {{ last_update.updated_at.strftime('%H:%M:%S') }}
            </small>
        </div>
    {% endif %}

    <div class="meta">
        Created: {{ post.created_at.strftime('%d %b %Y') }} | 
        Original Author: <strong style="color: #e5c07b;">{{ post.author.username }}</strong>
    </div>

    {% if current_user.is_authenticated %}
        <div style="margin-top: 20px; border-top: 2px solid #3a3f4b; padding-top: 15px;">
            <a class="btn edit-btn" href="/edit/{{ post.id }}">Add Update</a>
            {% if post.author == current_user %}
                <a class="btn delete-btn" href="/delete/{{ post.id }}" onclick="return confirm('Are you sure you want to delete this item?');">Delete</a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endfor %}

<script>
function toggleHistory(postId) {
    var historyDiv = document.getElementById("history-" + postId);
    var btn = document.getElementById("btn-" + postId);
    
    if (historyDiv.style.display === "none") {
        historyDiv.style.display = "block";
        btn.innerHTML = "▼ Hide previous updates"; 
        btn.style.color = "#5bc0de"; 
    } else {
        historyDiv.style.display = "none";
        btn.innerHTML = btn.getAttribute("data-text"); 
        btn.style.color = "#888"; 
    }
}
</script>
{% endblock %}